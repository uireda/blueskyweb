{% extends 'tourism/base.html' %}
{% load static %}

{% block title %}Paiement - {{ reservation.offer.title }}{% endblock %}

{% block extra_head %}
<script src="https://js.stripe.com/v3/"></script>
{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h3 class="mb-0">Finaliser votre réservation</h3>
                </div>
                <div class="card-body">
                    <!-- Récapitulatif de la réservation -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h5>Détails de la réservation</h5>
                            <ul class="list-unstyled">
                                <li><strong>Offre :</strong> {{ reservation.offer.title }}</li>
                                <li><strong>Destination :</strong> {{ reservation.offer.destination.name }}</li>
                                <li><strong>Dates :</strong> {{ reservation.offer.departure_date|date:"d/m/Y" }} - {{ reservation.offer.return_date|date:"d/m/Y" }}</li>
                                <li><strong>Participants :</strong> {{ reservation.participants_count }}</li>
                                <li><strong>Client :</strong> {{ reservation.client_name }}</li>
                                <li><strong>Email :</strong> {{ reservation.client_email }}</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h5>Récapitulatif des prix</h5>
                            <ul class="list-unstyled">
                                <li>Prix par personne : {{ reservation.offer.offer_price }}€</li>
                                <li>Nombre de participants : {{ reservation.participants_count }}</li>
                                <li><strong>Total : {{ reservation.total_price }}€</strong></li>
                                <hr>
                                {% if reservation.payment_type == 'deposit' %}
                                <li class="text-info"><strong>Acompte à payer : {{ reservation.deposit_amount }}€</strong></li>
                                <li class="text-muted">Solde restant : {{ reservation.remaining_amount }}€</li>
                                {% else %}
                                <li class="text-success"><strong>Paiement intégral : {{ reservation.total_price }}€</strong></li>
                                {% endif %}
                            </ul>
                        </div>
                    </div>

                    <!-- Formulaire de paiement Stripe -->
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Informations de paiement</h5>
                        </div>
                        <div class="card-body">
                            <form id="payment-form">
                                <div id="payment-element">
                                    <!-- Stripe Elements will create form elements here -->
                                </div>
                                <div id="payment-errors" role="alert" class="alert alert-danger d-none"></div>
                                <button id="submit-payment" class="btn btn-success btn-lg w-100 mt-3">
                                    <span id="button-text">
                                        Payer {{ reservation.amount_to_pay }}€
                                        {% if reservation.payment_type == 'deposit' %}(Acompte){% endif %}
                                    </span>
                                    <div id="spinner" class="spinner-border spinner-border-sm d-none" role="status">
                                        <span class="visually-hidden">Chargement...</span>
                                    </div>
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const stripe = Stripe('{{ stripe_public_key }}');
    const elements = stripe.elements({
        clientSecret: '{{ client_secret }}'
    });

    const paymentElement = elements.create('payment');
    paymentElement.mount('#payment-element');

    const form = document.getElementById('payment-form');
    const submitButton = document.getElementById('submit-payment');
    const buttonText = document.getElementById('button-text');
    const spinner = document.getElementById('spinner');
    const errorElement = document.getElementById('payment-errors');

    form.addEventListener('submit', async (event) => {
        event.preventDefault();

        // Désactiver le bouton et afficher le spinner
        submitButton.disabled = true;
        buttonText.classList.add('d-none');
        spinner.classList.remove('d-none');

        const {error} = await stripe.confirmPayment({
            elements,
            confirmParams: {
                return_url: '{{ request.build_absolute_uri }}/../succes/',
            },
        });

        if (error) {
            // Afficher l'erreur
            errorElement.textContent = error.message;
            errorElement.classList.remove('d-none');
            
            // Réactiver le bouton
            submitButton.disabled = false;
            buttonText.classList.remove('d-none');
            spinner.classList.add('d-none');
        }
    });
});
</script>
{% endblock %}
