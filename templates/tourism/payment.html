{% extends 'tourism/base.html' %}
{% load static %}

{% block title %}Paiement - {{ reservation.destination.name }} - Blue Sky Tourism{% endblock %}

{% block content %}
<section class="section" style="margin-top: 80px;">
    <div class="container">
        <div style="max-width: 800px; margin: 0 auto;">
            <h1 style="color: #2a5298; text-align: center; margin-bottom: 2rem;">Finaliser votre réservation</h1>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 3rem; margin-bottom: 3rem;">
                <!-- Récapitulatif de la réservation -->
                <div style="background: white; padding: 2rem; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1);">
                    <h2 style="color: #2a5298; margin-bottom: 1.5rem;">Récapitulatif de votre réservation</h2>
                    
                    <div style="margin-bottom: 1rem;">
                        <strong>Destination :</strong><br>
                        {{ reservation.destination.name }}
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <strong>Client :</strong><br>
                        {{ reservation.client_name }}<br>
                        {{ reservation.client_email }}<br>
                        {{ reservation.client_phone }}
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <strong>Date de départ :</strong><br>
                        {{ reservation.departure_date }}
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <strong>Nombre de voyageurs :</strong><br>
                        {{ reservation.travelers_count }} personne{{ reservation.travelers_count|pluralize }}
                    </div>
                    
                    {% if reservation.hotel_preference %}
                    <div style="margin-bottom: 1rem;">
                        <strong>Hôtel préféré :</strong><br>
                        {{ reservation.hotel_preference }}
                    </div>
                    {% endif %}
                    
                    {% if reservation.special_requests %}
                    <div style="margin-bottom: 1rem;">
                        <strong>Demandes spéciales :</strong><br>
                        {{ reservation.special_requests }}
                    </div>
                    {% endif %}
                    
                    <hr style="margin: 1.5rem 0;">
                    
                    <div style="font-size: 1.2rem; font-weight: bold; color: #ff6b35;">
                        <strong>Total à payer : {{ reservation.estimated_total }}€</strong>
                    </div>
                </div>
                
                <!-- Formulaire de paiement -->
                <div style="background: white; padding: 2rem; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1);">
                    <h2 style="color: #2a5298; margin-bottom: 1.5rem;">Informations de paiement</h2>
                    
                    <form id="payment-form">
                        <div id="card-element" style="padding: 15px; border: 2px solid #e0e0e0; border-radius: 8px; margin-bottom: 1rem;">
                            <!-- Stripe Elements va insérer le formulaire de carte ici -->
                        </div>
                        
                        <div id="card-errors" role="alert" style="color: #dc3545; margin-bottom: 1rem; font-size: 0.9rem;"></div>
                        
                        <button type="submit" id="submit-payment" class="search-btn" style="width: 100%; margin: 0;" disabled>
                            <span id="button-text">
                                <i class="fas fa-lock"></i> Payer {{ reservation.estimated_total }}€
                            </span>
                            <div id="spinner" style="display: none;">
                                <i class="fas fa-spinner fa-spin"></i> Traitement...
                            </div>
                        </button>
                        
                        <div style="text-align: center; margin-top: 1rem; font-size: 0.8rem; color: #666;">
                            <i class="fas fa-shield-alt"></i> Paiement sécurisé par Stripe
                        </div>
                    </form>
                </div>
            </div>
            
            <div style="text-align: center;">
                <a href="{% url 'tourism:destination_detail' reservation.destination.pk %}" style="color: #2a5298; text-decoration: none;">
                    <i class="fas fa-arrow-left"></i> Retour aux détails de la destination
                </a>
            </div>
        </div>
    </div>
</section>

<script src="https://js.stripe.com/v3/"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialiser Stripe
    const stripe = Stripe('{{ stripe_publishable_key }}');
    const elements = stripe.elements();
    
    // Créer l'élément de carte
    const cardElement = elements.create('card', {
        style: {
            base: {
                fontSize: '16px',
                color: '#424770',
                '::placeholder': {
                    color: '#aab7c4',
                },
            },
            invalid: {
                color: '#9e2146',
            },
        },
    });
    
    cardElement.mount('#card-element');
    
    // Gérer les erreurs de validation en temps réel
    cardElement.on('change', function(event) {
        const displayError = document.getElementById('card-errors');
        const submitButton = document.getElementById('submit-payment');
        
        if (event.error) {
            displayError.textContent = event.error.message;
            submitButton.disabled = true;
        } else {
            displayError.textContent = '';
            submitButton.disabled = false;
        }
    });
    
    // Gérer la soumission du formulaire
    const form = document.getElementById('payment-form');
    form.addEventListener('submit', async function(event) {
        event.preventDefault();
        
        const submitButton = document.getElementById('submit-payment');
        const buttonText = document.getElementById('button-text');
        const spinner = document.getElementById('spinner');
        
        // Désactiver le bouton et afficher le spinner
        submitButton.disabled = true;
        buttonText.style.display = 'none';
        spinner.style.display = 'inline-block';
        
        try {
            // Créer le Payment Intent
            const response = await fetch('{% url "tourism:payment" reservation.id %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                },
                body: JSON.stringify({})
            });
            
            const data = await response.json();
            
            if (data.error) {
                throw new Error(data.error);
            }
            
            // Confirmer le paiement
            const result = await stripe.confirmCardPayment(data.client_secret, {
                payment_method: {
                    card: cardElement,
                    billing_details: {
                        name: '{{ reservation.client_name }}',
                        email: '{{ reservation.client_email }}',
                    },
                }
            });
            
            if (result.error) {
                // Afficher l'erreur
                document.getElementById('card-errors').textContent = result.error.message;
                
                // Réactiver le bouton
                submitButton.disabled = false;
                buttonText.style.display = 'inline-block';
                spinner.style.display = 'none';
            } else {
                // Paiement réussi
                if (result.paymentIntent.status === 'succeeded') {
                    // Rediriger vers la page de succès
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = '{% url "tourism:payment_success" reservation.id %}';
                    
                    const csrfInput = document.createElement('input');
                    csrfInput.type = 'hidden';
                    csrfInput.name = 'csrfmiddlewaretoken';
                    csrfInput.value = document.querySelector('[name=csrfmiddlewaretoken]').value;
                    form.appendChild(csrfInput);
                    
                    const paymentIntentInput = document.createElement('input');
                    paymentIntentInput.type = 'hidden';
                    paymentIntentInput.name = 'payment_intent_id';
                    paymentIntentInput.value = result.paymentIntent.id;
                    form.appendChild(paymentIntentInput);
                    
                    document.body.appendChild(form);
                    form.submit();
                }
            }
        } catch (error) {
            document.getElementById('card-errors').textContent = 'Une erreur est survenue: ' + error.message;
            
            // Réactiver le bouton
            submitButton.disabled = false;
            buttonText.style.display = 'inline-block';
            spinner.style.display = 'none';
        }
    });
});
</script>

{% csrf_token %}
{% endblock %}
